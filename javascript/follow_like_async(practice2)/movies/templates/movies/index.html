{% extends 'base.html' %}

{% block content %}
  <h1>INDEX</h1>
  <a href="{% url 'movies:create' %}">[CREATE]</a>
  <hr />
  {% for movie in movies %}
    <a href="{% url 'movies:detail' movie.pk %}"><p>{{ movie.title }}</p></a>
    <p>작성자 : <a href="{% url 'accounts:profile' movie.user.username %}">{{ movie.user }}</a></b>
    <hr />

    {% comment %} 여기서부터 작성 {% endcomment %}

    <p><span id="liked-movie-{{ movie.pk }}"></span></p>
      <div>
        <form class="like-forms" data-movie-id="{{ movie.pk }}">
          {% csrf_token %}
          {% if request.user in movie.like_users.all %}
            <input type="submit" value="좋아요 취소" id="like-{{ movie.pk }}">
          {% else %}
            <input type="submit" value="좋아요" id="like-{{ movie.pk }}">
          {% endif %}
        </form>
      </div>
      <a href="{% url "movies:detail" movie.pk %}">상세 페이지</a>
      <hr>
  {% endfor %}
{% endblock %}

{% block script %}
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    const forms = document.querySelector('.like-forms')
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value

    forms.forEach((form) => {
      form.addEventListener('submit', function (event) {
        event.preventdefault()

        const movieId = event.target.dataset.movieId

        axios({
          method: 'post',
          url: `http://127.0.0.1:8000/movies/${movieId}/likes/`,
          headers: {'X-CSRFToken': csrftoken},
        })
          .then((response) => {
            
            const isLiked = response.data.is_liked
            const likeBtn = document.querySelector(`#like-${movieId}`)

            if (isLiked) {
              likeBtn.value = '좋아요 취소'
            } else {
              likeBtn.value = '좋아요'
            }

            const likedCount = response.data.liked_count
            const likedCountTag = document.querySelector(`#like-count-${movieId}`)
            likeCountTag.textContent = likedCount
          })
          .catch((error) => {
            console.log(error.response)
          })
      })
    })
  </script>
{% endblock script %}
